From 80bbfa6e5cf6ecfbd2c49e16f3d402d4630849ed Mon Sep 17 00:00:00 2001
From: Thomas Perl <thomas.perl@jollamobile.com>
Date: Fri, 4 Oct 2013 12:56:14 +0200
Subject: [PATCH 17/65] zypp: Fix double free in libzypp (TmpLineWriter takes
 ownership)

---
 backends/zypp/pk-backend-zypp.cpp | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/backends/zypp/pk-backend-zypp.cpp b/backends/zypp/pk-backend-zypp.cpp
index be230584a..ea2f45c52 100644
--- a/backends/zypp/pk-backend-zypp.cpp
+++ b/backends/zypp/pk-backend-zypp.cpp
@@ -226,7 +226,6 @@ class SystemdLogWriter : public zypp::log::LineWriter {
 public:
 	SystemdLogWriter()
 		: zypp::log::LineWriter()
-		  , m_writer(this)
 	{
 	}
 
@@ -248,9 +247,6 @@ public:
 			}
 		}
 	}
-
-private:
-	zypp::base::LogControl::TmpLineWriter m_writer;
 };
 
 
@@ -662,7 +658,7 @@ class PkBackendZYppPrivate {
 	std::vector<std::string> signatures;
 	EventDirector eventDirector;
 	PkBackendJob *currentJob;
-	SystemdLogWriter logWriter;
+	zypp::base::LogControl::TmpLineWriter *tmpLineWriter;
 	
 	pthread_mutex_t zypp_mutex;
 	ExecCounters exec;
@@ -1903,6 +1899,8 @@ pk_backend_initialize (PkBackend *backend)
 	priv->currentJob = 0;
 	priv->zypp_mutex = PTHREAD_MUTEX_INITIALIZER;
 	priv->exec = ExecCounters();
+	// tmpLineWriter takes ownership of new SystemdLogWriter
+	priv->tmpLineWriter = new zypp::base::LogControl::TmpLineWriter(new SystemdLogWriter);
 
 	g_debug ("zypp_backend_initialize");
 	//_updating_self = FALSE;
@@ -1917,6 +1915,10 @@ pk_backend_destroy (PkBackend *backend)
 {
 	g_debug ("zypp_backend_destroy");
 
+	if (priv->tmpLineWriter) {
+		delete priv->tmpLineWriter;
+	}
+
 	g_free (_repoName);
 	delete priv;
 }
-- 
2.13.5

