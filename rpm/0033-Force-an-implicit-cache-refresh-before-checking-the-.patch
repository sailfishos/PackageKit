From 050de7418d51cb0995a6bd2b867b23a0f0bcc5cd Mon Sep 17 00:00:00 2001
From: Martin Grimme <martin.grimme@gmail.com>
Date: Wed, 6 May 2015 16:15:27 +0200
Subject: [PATCH 33/38] Force an implicit cache refresh before checking the
 size of a dist upgrade. Fixes JB#28528

---
 backends/zypp/pk-backend-zypp.cpp | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/backends/zypp/pk-backend-zypp.cpp b/backends/zypp/pk-backend-zypp.cpp
index 552c0fb4c..027f209c0 100644
--- a/backends/zypp/pk-backend-zypp.cpp
+++ b/backends/zypp/pk-backend-zypp.cpp
@@ -4357,9 +4357,12 @@ backend_upgrade_system_thread (PkBackendJob *job, GVariant *params, gpointer use
 
 	gchar *id = parameters->distro_id;
 
+	gboolean do_refresh = false;
+
 	if (strstr(id, "nemo::query-size:") == id) {
 		id += strlen("nemo::query-size:");
 		pk_bitfield_add(transaction_flags, PK_TRANSACTION_FLAG_ENUM_SIMULATE);
+		do_refresh = true;
 		PK_ZYPP_LOG("Getting size of distro upgrade, with pattern = '%s'", id);
 	}
 
@@ -4385,6 +4388,7 @@ backend_upgrade_system_thread (PkBackendJob *job, GVariant *params, gpointer use
 					PK_TRANSACTION_FLAG_ENUM_ONLY_DOWNLOAD);
 			// Also try downloading dependencies of the pattern
 			install_pattern = true;
+			do_refresh = true;
 			break;
 		case PK_UPGRADE_KIND_ENUM_COMPLETE:
 			//MIL << "Installing upgrades and " << pattern_name << std::endl;
@@ -4395,7 +4399,6 @@ backend_upgrade_system_thread (PkBackendJob *job, GVariant *params, gpointer use
 			//MIL << "Downloading and installing upgrades" << std::endl;
 			break;
 	}
-	gboolean do_refresh = (parameters->upgrade_kind == PK_UPGRADE_KIND_ENUM_MINIMAL);
 	delete parameters;
 
 	ZyppJob zjob(job);
-- 
2.13.6

