From d2c1cc96a00a99649da68b48cf9647dbc1e4468d Mon, 10 Oct 2016 16:02:49 +0200
From: Thomas Perl <thomas.perl@jolla.com>
Date: Tue, 21 Jan 2014 16:34:16 +0100
Subject: [PATCH] [transaction] Always allow from setgid privileged. JB#14370


diff --git a/src/pk-transaction.c b/src/pk-transaction.c
index 32d58e6..886cb0c 100644
--- a/src/pk-transaction.c
+++ b/src/pk-transaction.c
@@ -35,6 +35,7 @@
 #include <sys/wait.h>
 #include <fcntl.h>
 #include <sys/stat.h>
+#include <grp.h>
 
 #include <glib/gstdio.h>
 #include <glib/gi18n.h>
@@ -2855,6 +2856,21 @@
 
 	g_return_val_if_fail (priv->sender != NULL, FALSE);
 
+	/* setgid privileged processes don't need additional authentication */
+	guint pid = pk_dbus_get_pid (priv->dbus, priv->sender);
+	gchar *path = g_strdup_printf ("/proc/%u", pid);
+	struct stat sender_stat;
+	if (stat(path, &sender_stat) == 0) {
+		struct group *sender_group = getgrgid (sender_stat.st_gid);
+		if (sender_group) {
+			g_debug ("Group of sender process: '%s'", sender_group->gr_name);
+			if (g_strcmp0 (sender_group->gr_name, "privileged") == 0) {
+				priv->skip_auth_check = TRUE;
+			}
+		}
+	}
+	g_free (path);
+
 	/* we don't need to authenticate at all to just download
 	 * packages or if we're running unit tests */
 	if (pk_bitfield_contain (transaction->priv->cached_transaction_flags,
