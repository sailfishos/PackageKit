From 5d21a710e179c2ce99783d48f299537a471a3de0 Mon Sep 17 00:00:00 2001
From: Thomas Perl <thomas.perl@jollamobile.com>
Date: Tue, 29 Oct 2013 01:37:23 +0100
Subject: [PATCH 26/65] zypp: Really, really refresh when "force" is set

There was an additional check in the repository refreshing code that
prevented repositories from being refreshed, even when forced due to
some timeout in libzypp's refresh logic.
---
 backends/zypp/pk-backend-zypp.cpp | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/backends/zypp/pk-backend-zypp.cpp b/backends/zypp/pk-backend-zypp.cpp
index d847405bb..bec3e3e4c 100644
--- a/backends/zypp/pk-backend-zypp.cpp
+++ b/backends/zypp/pk-backend-zypp.cpp
@@ -1235,8 +1235,11 @@ class AbortTransactionException {
 static gboolean
 zypp_refresh_meta_and_cache (RepoManager &manager, RepoInfo &repo, bool force = false)
 {
+	zypp::RepoManager::RawMetadataRefreshPolicy refreshPolicy =
+		force ? RepoManager::RefreshForced : RepoManager::RefreshIfNeeded;
+
 	try {
-		if (manager.checkIfToRefreshMetadata (repo, repo.url())    //RepoManager::RefreshIfNeededIgnoreDelay)
+		if (manager.checkIfToRefreshMetadata (repo, repo.url(), refreshPolicy)
 		    != RepoManager::REFRESH_NEEDED)
 			return TRUE;
 
-- 
2.13.5

