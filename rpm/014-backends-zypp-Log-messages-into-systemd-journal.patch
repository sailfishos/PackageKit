From 8d7aa5d571494be88cf7a366c364d23efb8d2bc7 Mon, 10 Oct 2016 15:51:38 +0200
From: Thomas Perl <thomas.perl@jollamobile.com>
Date: Wed, 2 Oct 2013 14:37:44 +0200
Subject: [PATCH] [backends] zypp: Log messages into systemd journal


diff --git a/backends/zypp/Makefile.am b/backends/zypp/Makefile.am
index cc683e5..5088d20 100644
--- a/backends/zypp/Makefile.am
+++ b/backends/zypp/Makefile.am
@@ -6,7 +6,7 @@
 plugin_LTLIBRARIES = libpk_backend_zypp.la
 libpk_backend_zypp_la_SOURCES =	pk-backend-zypp.cpp
 libpk_backend_zypp_la_LIBADD = $(PK_PLUGIN_LIBS)
-libpk_backend_zypp_la_LDFLAGS = -module -avoid-version $(ZYPP_LIBS)
+libpk_backend_zypp_la_LDFLAGS = -module -avoid-version $(ZYPP_LIBS) -lsystemd-journal
 libpk_backend_zypp_la_CFLAGS = $(PK_PLUGIN_CFLAGS) $(WARNINGFLAGS_CPP)
 libpk_backend_zypp_la_CXXFLAGS = $(PK_PLUGIN_CXXFLAGS) --std=c++0x -Wall -Woverloaded-virtual -Wnon-virtual-dtor
 libpk_backend_zypp_la_CPPFLAGS = $(PK_PLUGIN_CFLAGS) $(ZYPP_CFLAGS) -Wno-deprecated
diff --git a/backends/zypp/pk-backend-zypp.cpp b/backends/zypp/pk-backend-zypp.cpp
index 14bb728..eb233bb 100644
--- a/backends/zypp/pk-backend-zypp.cpp
+++ b/backends/zypp/pk-backend-zypp.cpp
@@ -40,6 +40,8 @@
 #include <unistd.h>
 #include <vector>
 
+#include <systemd/sd-journal.h>
+
 #include <glib.h>
 #include <glib/gi18n.h>
 #include <glib/gstdio.h>
@@ -206,6 +208,40 @@
 void zypp_backend_download_finished(PkBackendJob *job);
 void zypp_backend_installation_finished(PkBackendJob *job);
 void zypp_backend_removal_finished(PkBackendJob *job);
+
+
+/* Logging to systemd journal */
+class SystemdLogWriter : public zypp::log::LineWriter {
+public:
+	SystemdLogWriter()
+		: zypp::log::LineWriter()
+		  , m_writer(this)
+	{
+	}
+
+	virtual ~SystemdLogWriter()
+	{
+	}
+
+	virtual void writeOut(const std::string &message)
+	{
+		if (sd_journal_print(LOG_INFO, "pk-backend-zypp: %s", message.c_str()) < 0) {
+			/* Fallback: If systemd journal writing fails, write to logfile */
+			FILE *fp = fopen("/var/log/pk_backend_zypp", "at");
+			if (fp != NULL) {
+				fprintf(fp, "%s\n", message.c_str());
+				fclose(fp);
+			} else {
+				/* If we can't even open the log file, write to stderr */
+				fprintf(stderr, "%s\n", message.c_str());
+			}
+		}
+	}
+
+private:
+	zypp::base::LogControl::TmpLineWriter m_writer;
+};
+
 
 class ZyppBackendReceiver
 {
@@ -615,6 +651,7 @@
 	std::vector<std::string> signatures;
 	EventDirector eventDirector;
 	PkBackendJob *currentJob;
+	SystemdLogWriter logWriter;
 	
 	pthread_mutex_t zypp_mutex;
 	ExecCounters exec;
@@ -697,36 +734,6 @@
 	return zypp;
 }
 
-
-
-
-/**
-  * Enable and rotate zypp logging
-  */
-gboolean
-zypp_logging ()
-{
-	gchar *file = g_strdup ("/var/log/pk_backend_zypp");
-	gchar *file_old = g_strdup ("/var/log/pk_backend_zypp-1");
-
-	if (g_file_test (file, G_FILE_TEST_EXISTS)) {
-		struct stat buffer;
-		g_stat (file, &buffer);
-		// if the file is bigger than 10 MB rotate
-		if ((guint)buffer.st_size > 10485760) {
-			if (g_file_test (file_old, G_FILE_TEST_EXISTS))
-				g_remove (file_old);
-			g_rename (file, file_old);
-		}
-	}
-
-	base::LogControl::instance ().logfile(file);
-
-	g_free (file);
-	g_free (file_old);
-
-	return TRUE;
-}
 
 gboolean
 zypp_is_changeable_media (const Url &url)
@@ -1854,7 +1861,6 @@
 	priv->currentJob = 0;
 	priv->zypp_mutex = PTHREAD_MUTEX_INITIALIZER;
 	priv->exec = ExecCounters();
-	zypp_logging ();
 
 	g_debug ("zypp_backend_initialize");
 	//_updating_self = FALSE;
