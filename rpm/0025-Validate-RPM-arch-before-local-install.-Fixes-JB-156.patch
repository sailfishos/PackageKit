From 2d42a645ccd6e6cd579f44e6c0dc317467cbd442 Mon Sep 17 00:00:00 2001
From: Thomas Perl <thomas.perl@jolla.com>
Date: Tue, 11 Feb 2014 11:13:54 +0100
Subject: [PATCH 25/40] Validate RPM arch before local-install. Fixes JB#15666

---
 backends/zypp/pk-backend-zypp.cpp | 32 +++++++++++++++++++++++++++-----
 1 file changed, 27 insertions(+), 5 deletions(-)

diff --git a/backends/zypp/pk-backend-zypp.cpp b/backends/zypp/pk-backend-zypp.cpp
index c16194f79..c64985b8d 100644
--- a/backends/zypp/pk-backend-zypp.cpp
+++ b/backends/zypp/pk-backend-zypp.cpp
@@ -1264,10 +1264,20 @@ zypp_refresh_meta_and_cache (RepoManager &manager, RepoInfo &repo, bool force =
 
 
 static gboolean
-system_and_package_are_x86 (sat::Solvable item)
+system_and_package_are_x86 (Arch arch)
 {
-	// i586, i686, ... all should be considered the same arch for our comparison
-	return ( item.arch() == Arch_i586 && ZConfig::defaultSystemArchitecture() == Arch_i686 );
+	const Arch &systemArch = ZConfig::defaultSystemArchitecture();
+
+	// For x86 (32 and 64 bit), the system architectures are backwards-compatible
+	if (systemArch == Arch_i586) {
+		return (arch == Arch_i486);
+	} else if (systemArch == Arch_i686) {
+		return (arch == Arch_i486 || arch == Arch_i586);
+	} else if (systemArch == Arch_x86_64) {
+		return (arch == Arch_i486 || arch == Arch_i586 || arch == Arch_i686);
+	}
+
+	return FALSE;
 }
 
 static gboolean
@@ -1303,12 +1313,12 @@ zypp_filter_solvable (PkBitfield filters, const sat::Solvable &item)
 		if (i == PK_FILTER_ENUM_ARCH) {
 			if (item.arch () != ZConfig::defaultSystemArchitecture () &&
 			    item.arch () != Arch_noarch &&
-			    ! system_and_package_are_x86 (item))
+			    ! system_and_package_are_x86 (item.arch ()))
 				return TRUE;
 		}
 		if (i == PK_FILTER_ENUM_NOT_ARCH) {
 			if (item.arch () == ZConfig::defaultSystemArchitecture () ||
-			    system_and_package_are_x86 (item))
+			    system_and_package_are_x86 (item.arch ()))
 				return TRUE;
 		}
 		if (i == PK_FILTER_ENUM_SOURCE && !(isKind<SrcPackage>(item)))
@@ -2600,6 +2610,18 @@ backend_install_files_thread (PkBackendJob *job, GVariant *params, gpointer user
 			return;
 		}
 
+		// check if the file has an acceptable architecture
+		if (rpmHeader->tag_arch() != ZConfig::defaultSystemArchitecture () &&
+				rpmHeader->tag_arch() != ZConfig::instance().systemArchitecture () &&
+				rpmHeader->tag_arch() != Arch_noarch &&
+				! system_and_package_are_x86 (rpmHeader->tag_arch ())) {
+			zypp_backend_finished_error (
+				job, PK_ERROR_ENUM_LOCAL_INSTALL_FAILED,
+				"%s has wrong architecture: %s", full_paths[i],
+				rpmHeader->tag_arch ().asString (). c_str());
+			return;
+		}
+
 		// copy the rpm into tmpdir
 		string tempDest = tmpDir.path ().asString () + "/" + rpmHeader->tag_name () + ".rpm";
 		if (filesystem::copy (full_paths[i], tempDest) != 0) {
-- 
2.13.6

