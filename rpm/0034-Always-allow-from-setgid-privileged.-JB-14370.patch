From e89761ebda82c5c962486d5c46b2fe622cca9fe2 Mon Sep 17 00:00:00 2001
From: Thomas Perl <thomas.perl@jolla.com>
Date: Tue, 21 Jan 2014 16:34:16 +0100
Subject: [PATCH 34/65] Always allow from setgid privileged. JB#14370

---
 src/pk-transaction.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/src/pk-transaction.c b/src/pk-transaction.c
index 32d58e629..886cb0cf0 100644
--- a/src/pk-transaction.c
+++ b/src/pk-transaction.c
@@ -35,6 +35,7 @@
 #include <sys/wait.h>
 #include <fcntl.h>
 #include <sys/stat.h>
+#include <grp.h>
 
 #include <glib/gstdio.h>
 #include <glib/gi18n.h>
@@ -2855,6 +2856,21 @@ pk_transaction_obtain_authorization (PkTransaction *transaction,
 
 	g_return_val_if_fail (priv->sender != NULL, FALSE);
 
+	/* setgid privileged processes don't need additional authentication */
+	guint pid = pk_dbus_get_pid (priv->dbus, priv->sender);
+	gchar *path = g_strdup_printf ("/proc/%u", pid);
+	struct stat sender_stat;
+	if (stat(path, &sender_stat) == 0) {
+		struct group *sender_group = getgrgid (sender_stat.st_gid);
+		if (sender_group) {
+			g_debug ("Group of sender process: '%s'", sender_group->gr_name);
+			if (g_strcmp0 (sender_group->gr_name, "privileged") == 0) {
+				priv->skip_auth_check = TRUE;
+			}
+		}
+	}
+	g_free (path);
+
 	/* we don't need to authenticate at all to just download
 	 * packages or if we're running unit tests */
 	if (pk_bitfield_contain (transaction->priv->cached_transaction_flags,
-- 
2.13.5

