From d5c62b1bb0239fce107213c45e1e56f33c8f32f8 Mon Sep 17 00:00:00 2001
From: Pekka Vuorela <pekka.vuorela@jollamobile.com>
Date: Thu, 12 Oct 2017 15:14:12 +0300
Subject: [PATCH 08/38] Improve progress output on non-80x25 terminals

---
 lib/packagekit-glib2/pk-progress-bar.c | 50 ++++++++++++++++++++++++++++------
 1 file changed, 42 insertions(+), 8 deletions(-)

diff --git a/lib/packagekit-glib2/pk-progress-bar.c b/lib/packagekit-glib2/pk-progress-bar.c
index 3917c2cf2..10eb6eea2 100644
--- a/lib/packagekit-glib2/pk-progress-bar.c
+++ b/lib/packagekit-glib2/pk-progress-bar.c
@@ -23,6 +23,7 @@
 #include <string.h>
 #include <unistd.h>
 #include <fcntl.h>
+#include <sys/ioctl.h>
 
 #include "pk-progress-bar.h"
 
@@ -79,7 +80,7 @@ gboolean
 pk_progress_bar_set_padding (PkProgressBar *progress_bar, guint padding)
 {
 	g_return_val_if_fail (PK_IS_PROGRESS_BAR (progress_bar), FALSE);
-	g_return_val_if_fail (padding < 100, FALSE);
+	g_return_val_if_fail (padding > 0, FALSE);
 	progress_bar->priv->padding = padding;
 	return TRUE;
 }
@@ -97,7 +98,7 @@ gboolean
 pk_progress_bar_set_size (PkProgressBar *progress_bar, guint size)
 {
 	g_return_val_if_fail (PK_IS_PROGRESS_BAR (progress_bar), FALSE);
-	g_return_val_if_fail (size < 100, FALSE);
+	g_return_val_if_fail (size > 0, FALSE);
 	progress_bar->priv->size = size;
 	return TRUE;
 }
@@ -116,12 +117,24 @@ pk_progress_bar_draw (PkProgressBar *self, gint percentage)
 	if (percentage == G_MININT)
 		return FALSE;
 
+	/* print line without progress bar */
+	if (percentage == PK_PROGRESS_BAR_PERCENTAGE_INVALID) {
+		/* 11 = strlen(" [] (00%)  ") */
+		gchar *fill = g_strnfill (self->priv->size + 11, ' ');
+		/* 0x1B + 8 = restore cursor */
+		gchar *tmp = g_strdup_printf ("%c8%s", 0x1B, fill);
+		pk_progress_bar_console (self, tmp);
+		g_free (tmp);
+		g_free (fill);
+		return TRUE;
+	}
+
 	/* restore cursor */
 	str = g_string_new ("");
 	g_string_append_printf (str, "%c8", 0x1B);
 
 	section = (guint) ((gfloat) self->priv->size / (gfloat) 100.0 * (gfloat) percentage);
-	g_string_append (str, "[");
+	g_string_append (str, " [");
 	for (i = 0; i < section; i++)
 		g_string_append (str, "=");
 	for (i = 0; i < self->priv->size - section; i++)
@@ -130,7 +143,7 @@ pk_progress_bar_draw (PkProgressBar *self, gint percentage)
 	if (percentage >= 0 && percentage < 100)
 		g_string_append_printf (str, "(%i%%)  ", percentage);
 	else
-		g_string_append (str, "        ");
+		g_string_append (str, "       ");
 	pk_progress_bar_console (self, str->str);
 	g_string_free (str, TRUE);
 	return TRUE;
@@ -161,7 +174,7 @@ pk_progress_bar_pulse_bar (PkProgressBar *self)
 			self->priv->pulse_state.position--;
 	}
 
-	g_string_append (str, "[");
+	g_string_append (str, " [");
 	for (i = 0; i < (gint)self->priv->pulse_state.position-1; i++)
 		g_string_append (str, " ");
 	g_string_append (str, "==");
@@ -245,7 +258,7 @@ out:
  * @length: the desired length of the output string, with padding
  *
  * Returns the text padded to a length with spaces. If the string is
- * longer than length then a longer string is returned.
+ * longer than length then the string is elided to fit the space.
  *
  * Return value: The padded string
  **/
@@ -263,6 +276,16 @@ pk_strpad (const gchar *data, guint length)
 	/* ITS4: ignore, only used for formatting */
 	data_len = strlen (data);
 
+	/* elide text with horizontal ellipsis */
+	if (data_len > length) {
+		gchar *tmp = g_strdup (data);
+		tmp[length - 1] = '\0';
+		//"\xe2\x80\xa6" = horizontal ellipsis (in UTF-8)
+		gchar *result = g_strdup_printf ("%s\xe2\x80\xa6", tmp);
+		g_free (tmp);
+		return result;
+	}
+
 	/* calculate */
 	size = (length - data_len);
 	if (size <= 0)
@@ -299,10 +322,21 @@ pk_progress_bar_start (PkProgressBar *progress_bar, const gchar *text)
 	g_free (progress_bar->priv->old_start_text);
 	progress_bar->priv->old_start_text = g_strdup (text);
 
+	/* Determine terminal size, and calculate text/bar size from it */
+	struct winsize w;
+	if (ioctl (progress_bar->priv->tty_fd, TIOCGWINSZ, &w) == 0) {
+		/* 11 = strlen(" [] (00%)  ") */
+		int available_width = w.ws_col - 1 - 11;
+		int progress_bar_width = available_width / 3;
+		int message_width = available_width - progress_bar_width;
+		pk_progress_bar_set_padding(progress_bar, message_width);
+		pk_progress_bar_set_size(progress_bar, progress_bar_width);
+	}
+
 	/* finish old value */
 	str = g_string_new ("");
 	if (progress_bar->priv->percentage != G_MININT) {
-		pk_progress_bar_draw (progress_bar, 100);
+		pk_progress_bar_draw (progress_bar, PK_PROGRESS_BAR_PERCENTAGE_INVALID);
 		g_string_append (str, "\n");
 	}
 
@@ -344,7 +378,7 @@ pk_progress_bar_end (PkProgressBar *progress_bar)
 		return FALSE;
 
 	progress_bar->priv->percentage = G_MININT;
-	pk_progress_bar_draw (progress_bar, 100);
+	pk_progress_bar_draw (progress_bar, PK_PROGRESS_BAR_PERCENTAGE_INVALID);
 	str = g_string_new ("");
 	g_string_append_printf (str, "\n");
 	pk_progress_bar_console (progress_bar, str->str);
-- 
2.13.6

