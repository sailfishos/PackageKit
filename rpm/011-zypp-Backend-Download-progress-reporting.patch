From fdf60bc3e1358a550f89348812e1f78d97587d42 Mon, 10 Oct 2016 15:51:09 +0200
From: Thomas Perl <thomas.perl@jollamobile.com>
Date: Mon, 19 Aug 2013 13:12:05 +0200
Subject: [PATCH] zypp Backend: Download progress reporting


Include downloading of packages in total progress calculation.

[backends] zypp: Overall download progress reporting

diff --git a/backends/zypp/pk-backend-zypp.cpp b/backends/zypp/pk-backend-zypp.cpp
index bdff077..9089eab 100644
--- a/backends/zypp/pk-backend-zypp.cpp
+++ b/backends/zypp/pk-backend-zypp.cpp
@@ -203,6 +203,7 @@
 static PkBackendZYppPrivate *priv = 0;
 
 /* Overall progress update helpers */
+void zypp_backend_download_finished(PkBackendJob *job);
 void zypp_backend_installation_finished(PkBackendJob *job);
 void zypp_backend_removal_finished(PkBackendJob *job);
 
@@ -410,6 +411,7 @@
 	virtual void finish (zypp::Resolvable::constPtr resolvable, Error error, const std::string &konreason)
 	{
 		MIL << resolvable << " " << error << " " << _package_id << std::endl;
+		zypp_backend_download_finished(_job);
 		update_sub_percentage (100);
 		clear_package_id ();
 	}
@@ -557,13 +559,15 @@
 		, current_installs(0)
 		, total_removals(0)
 		, current_removals(0)
+		, total_downloads(0)
+		, current_downloads(0)
 	{
 	}
 
 	void update(PkBackendJob *job)
 	{
-		int total = (total_installs + total_removals);
-		int current = (current_installs + current_removals);
+		int total = (total_downloads + total_installs + total_removals);
+		int current = (current_downloads + current_installs + current_removals);
 
 		if (current > total) {
 			MIL << "current > total!" << std::endl;
@@ -580,12 +584,16 @@
 		current_installs = 0;
 		total_removals = 0;
 		current_removals = 0;
+		total_downloads = 0;
+		current_downloads = 0;
 	}
 
 	int total_installs;
 	int current_installs;
 	int total_removals;
 	int current_removals;
+	int total_downloads;
+	int current_downloads;
 };
 
 class PkBackendZYppPrivate {
@@ -597,6 +605,12 @@
 	pthread_mutex_t zypp_mutex;
 	ExecCounters exec;
 };
+
+void zypp_backend_download_finished(PkBackendJob *job)
+{
+	priv->exec.current_downloads += 1;
+	priv->exec.update(job);
+}
 
 void zypp_backend_installation_finished(PkBackendJob *job)
 {
@@ -1591,13 +1605,19 @@
 		priv->exec.reset();
 		for (ResPool::const_iterator it = pool.begin (); it != pool.end (); ++it) {
 			if (it->status().isToBeInstalled()) {
-				priv->exec.total_installs += 1;
+				if (!only_download) {
+					priv->exec.total_installs += 1;
+				}
+				priv->exec.total_downloads += 1;
 			} else if (it->status().isToBeUninstalled() &&
 					!it->status().isToBeUninstalledDueToUpgrade()) {
-				priv->exec.total_removals += 1;
+				if (!only_download) {
+					priv->exec.total_removals += 1;
+				}
 			}
 		}
 		MIL << "Summary before commit: " << std::endl;
+		MIL << " total downloads = " << priv->exec.total_downloads << std::endl;
 		MIL << " total installs = " << priv->exec.total_installs << std::endl;
 		MIL << " total removals = " << priv->exec.total_removals << std::endl;
 
