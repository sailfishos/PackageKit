From 1fa52fa32cdab49747e966dd5cc50a0bfce9c4bc Mon Sep 17 00:00:00 2001
From: Martin Grimme <martin.grimme@gmail.com>
Date: Fri, 2 Oct 2015 09:42:17 +0200
Subject: [PATCH 63/65] Do not let space requirement become negative.
 Contributes to JB#31091

---
 backends/zypp/pk-backend-zypp.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/backends/zypp/pk-backend-zypp.cpp b/backends/zypp/pk-backend-zypp.cpp
index cfa624adc..cd51da92c 100644
--- a/backends/zypp/pk-backend-zypp.cpp
+++ b/backends/zypp/pk-backend-zypp.cpp
@@ -2093,9 +2093,9 @@ zypp_perform_execution (PkBackendJob *job, ZYpp::Ptr zypp, PerformType type, gbo
 				total_cached_bytes);
 
 		int64_t required_space_bytes_download = total_download_bytes;
-		int64_t required_space_bytes_installation = (type == UPGRADE) ? (total_install_bytes - total_remove_bytes)
+		int64_t required_space_bytes_installation = (type == UPGRADE) ? MAX(0, total_install_bytes - total_remove_bytes)
 		                                                              // it is the worst case if the biggest package gets installed last
-		                                                              : (biggest_package_download + total_install_bytes - total_remove_bytes);
+		                                                              : (biggest_package_download + MAX(0, total_install_bytes - total_remove_bytes));
 
 		// UPGRADE packages are downloaded to the /home partition, but are installed to rootfs
 		int64_t free_space_bytes_download = (type == UPGRADE) ? get_free_disk_space("/home")
-- 
2.13.5

